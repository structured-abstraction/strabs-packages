name: Publish

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release"
        required: true
        type: choice
        options:
          - strabs-doit
          - strabs-deploy
          - strabs-juggernaut
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - none
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: publish
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4

      - name: Determine version
        id: version
        run: |
          PKG_DIR="packages/${{ inputs.package }}"
          CURRENT=$(grep '^version = ' "$PKG_DIR/pyproject.toml" | head -1 | sed 's/version = "\(.*\)"/\1/')

          if [[ "${{ inputs.bump }}" == "none" ]]; then
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Keeping version $CURRENT"
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            case "${{ inputs.bump }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "Bumping $CURRENT -> $NEW_VERSION"

            # Update pyproject.toml
            sed -i "s/^version = \"$CURRENT\"/version = \"$NEW_VERSION\"/" "$PKG_DIR/pyproject.toml"

            # Update __init__.py
            INIT_FILE=$(find "$PKG_DIR/src" -name "__init__.py" | head -1)
            sed -i "s/__version__ = \"$CURRENT\"/__version__ = \"$NEW_VERSION\"/" "$INIT_FILE"
          fi

          echo "dir=$PKG_DIR" >> $GITHUB_OUTPUT

      - name: Commit and tag
        if: inputs.bump != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(${{ inputs.package }}): bump version to ${{ steps.version.outputs.version }}"
          git tag "${{ inputs.package }}-v${{ steps.version.outputs.version }}"
          git push origin HEAD:${{ github.ref_name }} --tags

      - name: Build
        run: uv build --package ${{ inputs.package }}

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
